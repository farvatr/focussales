<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Focus Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #1b002d;
      color: white;
      margin: 0;
      padding: 1rem;
    }
    h1, h2 {
      color: #ffffff;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .tabs button {
      padding: 0.5rem 1rem;
      background: #933DC9;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .card {
      background: #2e004d;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .metric {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    input[type="number"] {
      width: 80px;
      padding: 0.4rem;
      border-radius: 6px;
      border: none;
      text-align: center;
    }
    button {
      padding: 0.4rem 0.6rem;
      background: #933DC9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    canvas {
      background: white;
      border-radius: 10px;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      color: white;
    }
    th, td {
      border: 1px solid #933DC9;
      padding: 6px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="auth">
    <h1>Sales Focus</h1>
    <p>Введите имя:</p>
    <input type="text" id="usernameInput" />
    <button onclick="login()">Войти</button>
  </div>

  <div id="app" style="display:none;">
    <h2>Добро пожаловать, <span id="userDisplay"></span></h2>
    <div class="tabs">
      <button onclick="switchTab('today')">Сегодня</button>
      <button onclick="switchTab('analytics')">Аналитика</button>
    </div>

    <div id="todayTab">
      <div class="card" id="metrics"></div>
      <div class="card">
        <canvas id="chart" height="100"></canvas>
      </div>
    </div>

    <div id="analyticsTab" style="display:none;">
      <div class="card">
        <label><input type="radio" name="period" value="day" checked onchange="renderAnalytics()"> День</label>
        <label><input type="radio" name="period" value="week" onchange="renderAnalytics()"> Неделя</label>
        <label><input type="radio" name="period" value="month" onchange="renderAnalytics()"> Месяц</label>
      </div>
      <div class="card">
        <canvas id="historyChart" height="100"></canvas>
      </div>
      <div class="card">
        <table>
          <thead><tr><th>Дата</th><th>Звонки</th><th>Дозвоны</th><th>Встречи</th><th>Назначено</th><th>КП назн.</th><th>КП пров.</th></tr></thead>
          <tbody id="historyTable"></tbody>
        </table>
      </div>
      <div class="card">
        <strong>Советы:</strong>
        <p id="adviceMain"></p>
        <p id="adviceExtra" style="color: #bbb;"></p>
      </div>
    </div>
  </div>

  <script>
    const metrics = ["calls", "reached", "meetings", "scheduled", "kpset", "kpsent"];
    const names = {
      calls: "Звонки",
      reached: "Дозвоны",
      meetings: "Встречи",
      scheduled: "Назначено",
      kpset: "КП назн.",
      kpsent: "КП пров."
    };
    let data = {};
    metrics.forEach(k => data[k] = 0);

    function login() {
      const name = document.getElementById("usernameInput").value;
      if (!name) return;
      localStorage.setItem("username", name);
      document.getElementById("userDisplay").textContent = name;
      document.getElementById("auth").style.display = "none";
      document.getElementById("app").style.display = "block";
      render();
    }

    const storedName = localStorage.getItem("username");
    if (storedName) {
      document.getElementById("usernameInput").value = storedName;
      login();
    }

    function render() {
      const box = document.getElementById("metrics");
      box.innerHTML = "";
      metrics.forEach(m => {
        const wrap = document.createElement("div");
        wrap.className = "metric";
        wrap.innerHTML = `
          <strong>${names[m]}:</strong>
          <span id="${m}Val">0</span>
          <button onclick="inc('${m}', 1)">+</button>
          <button onclick="inc('${m}', -1)">−</button>
          <input type="number" id="${m}Input" />
          <button onclick="set('${m}')">Ввод</button>
        `;
        box.appendChild(wrap);
      });
      update();
    }

    function inc(k, v) {
      data[k] = Math.max(0, data[k] + v);
      if (k === "meetings") adjustGoals();
      update();
    }

    function set(k) {
      const val = parseInt(document.getElementById(k + "Input").value);
      if (!isNaN(val)) {
        data[k] = Math.max(0, val);
        if (k === "meetings") adjustGoals();
        update();
      }
    }

    function adjustGoals() {
      if (data.meetings >= 3) {
        data.calls = 30;
        data.reached = 10;
      } else if (data.meetings === 2) {
        data.calls = 50;
        data.reached = 15;
      } else if (data.meetings === 1) {
        data.calls = 60;
        data.reached = 20;
      } else {
        data.calls = 70;
        data.reached = 25;
      }
    }

    function update() {
      metrics.forEach(m => {
        document.getElementById(m + "Val").textContent = data[m];
      });
      save();
      chart.data.datasets[0].data = metrics.map(m => data[m]);
      chart.update();
    }

    function save() {
      const day = new Date().toISOString().slice(0,10);
      const all = JSON.parse(localStorage.getItem("history") || "[]").filter(d => d.date !== day);
      all.push({ date: day, ...data });
      localStorage.setItem("history", JSON.stringify(all));
    }

    function switchTab(t) {
      document.getElementById("todayTab").style.display = t === "today" ? "block" : "none";
      document.getElementById("analyticsTab").style.display = t === "analytics" ? "block" : "none";
      if (t === "analytics") renderAnalytics();
    }

    const chart = new Chart(document.getElementById("chart"), {
      type: "bar",
      data: {
        labels: metrics.map(m => names[m]),
        datasets: [{ label: "Сегодня", data: [0,0,0,0,0,0], backgroundColor: "#933DC9" }]
      }
    });

    const histChart = new Chart(document.getElementById("historyChart"), {
      type: "line",
      data: { labels: [], datasets: [] },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });

    function renderAnalytics() {
      const period = document.querySelector('input[name="period"]:checked').value;
      const all = JSON.parse(localStorage.getItem("history") || "[]");
      const now = new Date();
      const cutoff = new Date(now);
      if (period === "week") cutoff.setDate(now.getDate() - 6);
      if (period === "month") cutoff.setDate(now.getDate() - 29);
      const dataSet = all.filter(r => new Date(r.date) >= cutoff);
      const labels = dataSet.map(d => d.date);
      histChart.data.labels = labels;
      histChart.data.datasets = metrics.map((m, i) => ({
        label: names[m],
        data: dataSet.map(d => d[m]),
        borderColor: `hsl(${i * 50}, 80%, 70%)`,
        backgroundColor: "transparent"
      }));
      histChart.update();
      const table = document.getElementById("historyTable");
      table.innerHTML = "";
      dataSet.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.date}</td>` + metrics.map(m => `<td>${row[m]}</td>`).join("");
        table.appendChild(tr);
      });
      const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
      let a = dataSet.at(-1) || {};
      document.getElementById("adviceMain").textContent = a.calls < 20 ? "Нужно больше звонков." : "Отличный темп!";
      document.getElementById("adviceExtra").textContent = a.reached < 10 ? "Проверь качество базы." : "Дозвоны на уровне.";
    }
  </script>
</body>
</html>
