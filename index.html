<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Личный кабинет – метрики и аналитика</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-main: #141018;
      --card-bg: #1f1928;
      --accent: #f3c98b;
      --accent-dark: #e3b06a;
      --text-main: #ffffff;
      --text-muted: #b4acbf;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    body {
      background: radial-gradient(circle at 10% 0%, #2b2237 0, #141018 40%, #050307 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .wrapper {
      width: 100%;
      max-width: 1100px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* ЛОГИН */

    .login-card {
      background: var(--card-bg);
      padding: 30px 28px 26px;
      border-radius: 20px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
    }

    .login-card h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .login-label {
      font-size: 13px;
      margin-bottom: 6px;
      display: block;
    }

    .login-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #30263f;
      background: #1a1324;
      color: var(--text-main);
      outline: none;
    }

    .login-input::placeholder {
      color: #7a6d94;
    }

    .login-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(243, 201, 139, 0.5);
    }

    .login-button {
      margin-top: 18px;
      width: 100%;
      padding: 11px 10px;
      border: none;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #2c1f0f;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
    }

    .login-button:hover {
      filter: brightness(1.03);
      transform: translateY(-1px);
    }

    .login-button:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.8);
    }

    /* ДАШБОРД + АНАЛИТИКА */

    .dashboard-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px 24px 20px;
      width: 100%;
      box-shadow: 0 0 35px rgba(0, 0, 0, 0.75);
    }

    .dashboard-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .dashboard-title {
      font-size: 20px;
      font-weight: bold;
    }

    .dashboard-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-pill {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      font-size: 13px;
    }

    .analytics-btn,
    .back-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-main);
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
    }

    .analytics-btn:hover,
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 900px) {
      .metrics-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }

    .metric-card {
      background: #1b1424;
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .metric-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
      min-height: 32px;
    }

    .metric-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metric-input {
      flex: 1;
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid #32263e;
      background: #150f1e;
      color: var(--text-main);
      text-align: center;
      font-size: 16px;
    }

    .metric-input::-webkit-outer-spin-button,
    .metric-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .metric-input[type=number] {
      -moz-appearance: textfield;
    }

    .metric-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.06);
      color: var(--accent);
      font-size: 18px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .metric-btn:hover {
      background: rgba(255, 255, 255, 0.14);
    }

    .metric-btn:active {
      transform: translateY(1px);
    }

    .footer-note {
      margin-top: 22px;
      padding: 14px 18px;
      font-size: 13px;
      color: var(--text-main);
      background: #1f1928;
      border-radius: 14px;
      border: 1px solid rgba(243, 201, 139, 0.35);
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.45);
      line-height: 1.45;
    }

    .advice-title {
      font-weight: bold;
      margin-bottom: 6px;
      color: var(--accent);
    }

    .advice-line {
      margin-top: 2px;
    }

    /* Подсказка над метриками */

    .metrics-hint {
      margin-bottom: 14px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #1b1424;
      border: 1px solid rgba(243, 201, 139, 0.4);
      font-size: 13px;
      color: var(--text-main);
      box-shadow: 0 0 14px rgba(0,0,0,0.45);
    }

    .metrics-hint-avg {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .metric-input.metric-low {
      color: #ff6b6b;
      font-weight: bold;
    }

    .metric-input.metric-high {
      color: #4cd964;
      font-weight: bold;
    }

    /* Цели на день */
    .targets-block {
      margin-top: 20px;
      padding: 12px 14px;
      border-radius: 16px;
      background: #1b1424;
      border: 1px solid rgba(255,255,255,0.06);
      font-size: 12px;
    }

    .targets-title {
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--text-main);
      font-weight: bold;
    }

    .targets-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .targets-table th,
    .targets-table td {
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 4px 6px;
      text-align: center;
    }

    .targets-table th {
      color: var(--text-muted);
      font-weight: normal;
    }

    .targets-table tr:last-child td {
      border-bottom: none;
    }

    .targets-metric-name {
      text-align: left !important;
      white-space: nowrap;
    }

    /* Аналитика */

    .period-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      gap: 4px;
      margin-bottom: 16px;
    }

    .period-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
    }

    .period-btn.active {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-main);
    }

    .analytics-body {
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 10px;
    }

    .analytics-card {
      background: #1b1424;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 12px;
    }

    .analytics-value {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .analytics-section-title {
      margin-top: 18px;
      font-size: 13px;
      font-weight: bold;
      color: var(--text-main);
    }

    .chart-wrapper {
      margin-top: 18px;
      padding: 12px 14px 10px;
      border-radius: 18px;
      background: #1b1424;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .chart-title {
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--text-main);
    }

    #metricsChart {
      width: 100%;
      height: 170px;
      display: block;
    }

    .chart-bar {
      fill: rgba(243, 201, 139, 0.9);
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .chart-legend span::before {
      content: "";
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(243, 201, 139, 0.9);
      margin-right: 4px;
    }

    /* История */

    .history-block {
      margin-top: 18px;
      padding: 10px 12px;
      border-radius: 16px;
      background: #1b1424;
      border: 1px solid rgba(255,255,255,0.06);
      font-size: 12px;
    }

    .history-title {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--text-main);
    }

    .history-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .history-filters label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-filters input[type="date"] {
      background: #150f1e;
      border-radius: 8px;
      border: 1px solid #32263e;
      color: var(--text-main);
      padding: 4px 6px;
      font-size: 11px;
    }

    .history-button {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: var(--text-main);
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .history-button:hover {
      background: rgba(255,255,255,0.16);
    }

    .history-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Снежинки */

    .snowflake {
      position: fixed;
      top: -10px;
      color: white;
      font-size: 14px;
      opacity: 0.8;
      pointer-events: none;
      animation: fall linear infinite;
      z-index: 999;
    }

    @keyframes fall {
      to { transform: translateY(110vh); opacity: 0.3; }
    }

    /* Аналитика по центру, прямоугольная */

    #analyticsScreen .dashboard-card {
      max-width: 650px;
      margin: 0 auto;
      border-radius: 16px;
    }

    #analyticsScreen .analytics-grid {
      grid-template-columns: 1fr 1fr 1fr;
      margin-top: 12px;
    }

    #analyticsScreen .score-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    #historyGrid {
      margin-top: 8px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    /* Встроенный виджет подсказок над метриками */
    #inlineAdvice {
      margin-bottom: 16px;
      width: 100%;
      max-width: none;
      position: relative;
      background: #1b1424;
      border: 1px solid rgba(243,201,139,0.6);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      display: none;
    }

    #inlineAdviceClose {
      position: absolute;
      top: 8px;
      right: 10px;
      cursor: pointer;
      font-size: 14px;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Экран входа -->
    <section class="screen active" id="loginScreen">
      <div class="login-card">
        <h2>Вход в личный кабинет</h2>
        <p class="login-subtitle">Введите своё имя, чтобы перейти к управлению метриками продаж.</p>
        <label class="login-label" for="loginName">Имя</label>
        <input id="loginName" class="login-input" type="text" placeholder="Например, Антон" />
        <button class="login-button" id="loginButton">Войти</button>
      </div>
    </section>

    <!-- Экран дашборда -->
    <section class="screen" id="dashboardScreen">
      <div class="dashboard-card">
        <header class="dashboard-header">
          <div>
            <div class="dashboard-title">Воронка продаж</div>
            <div class="dashboard-subtitle">Управляйте ключевыми метриками: от звонка до оплаты.</div>
          </div>
          <div class="header-actions">
            <button class="analytics-btn" id="analyticsButton">Аналитика</button>
            <div class="user-pill" id="userPill">Пользователь</div>
          </div>
        </header>

        <!-- Встроенный виджет советов -->
        <div id="inlineAdvice">
          <div id="inlineAdviceClose">✖</div>
          <div class="advice-title">Советы по метрикам</div>
          <div class="advice-line"><strong>Наборы:</strong> <span id="inlineAdviceSets"></span></div>
          <div class="advice-line"><strong>Активные звонки:</strong> <span id="inlineAdviceCalls"></span></div>
        </div>

        <div class="metrics-hint">
          <strong>Подсказка по цветам:</strong>
          <span>метрики ниже среднего подсвечены красным, выше среднего — зелёным.</span>
          <span class="metrics-hint-avg">Текущее среднее значение: <span id="metricsAvg">0.0</span></span>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Количество наборов</div>
            <div class="metric-controls">
              <button class="metric-btn" data-action="dec">-</button>
              <input type="number" id="metricSets" class="metric-input" value="0" min="0" />
              <button class="metric-btn" data-action="inc">+</button>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Активные звонки</div>
            <div class="metric-controls">
              <button class="metric-btn" data-action="dec">-</button>
              <input type="number" id="metricCalls" class="metric-input" value="0" min="0" />
              <button class="metric-btn" data-action="inc">+</button>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Назначено встреч</div>
            <div class="metric-controls">
              <button class="metric-btn" data-action="dec">-</button>
              <input type="number" id="metricMeetPlan" class="metric-input" value="0" min="0" />
              <button class="metric-btn" data-action="inc">+</button>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Проведено встреч</div>
            <div class="metric-controls">
              <button class="metric-btn" data-action="dec">-</button>
              <input type="number" id="metricMeetDone" class="metric-input" value="0" min="0" />
              <button class="metric-btn" data-action="inc">+</button>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Отправлено КП</div>
            <div class="metric-controls">
              <button class="metric-btn" data-action="dec">-</button>
              <input type="number" id="metricKP" class="metric-input" value="0" min="0" />
              <button class="metric-btn" data-action="inc">+</button>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Получено оплат</div>
            <div class="metric-controls">
              <button class="metric-btn" data-action="dec">-</button>
              <input type="number" id="metricDeals" class="metric-input" value="0" min="0" />
              <button class="metric-btn" data-action="inc">+</button>
            </div>
          </div>
        </div>

        <div class="targets-block">
          <div class="targets-title">Цели на сегодня</div>
          <table class="targets-table">
            <thead>
              <tr>
                <th></th>
                <th>12:00</th>
                <th>14:00</th>
                <th>16:00</th>
                <th>19:00</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="targets-metric-name">Количество наборов</td>
                <td>30</td>
                <td>50</td>
                <td>70</td>
                <td>70</td>
              </tr>
              <tr>
                <td class="targets-metric-name">Активные звонки</td>
                <td>10</td>
                <td>15</td>
                <td>20</td>
                <td>25</td>
              </tr>
              <tr>
                <td class="targets-metric-name">Назначено встреч</td>
                <td>1</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
              </tr>
              <tr>
                <td class="targets-metric-name">Проведено встреч</td>
                <td>0</td>
                <td>1</td>
                <td>2</td>
                <td>2</td>
              </tr>
              <tr>
                <td class="targets-metric-name">Отправлено КП</td>
                <td>0</td>
                <td>0</td>
                <td>1</td>
                <td>2</td>
              </tr>
              <tr>
                <td class="targets-metric-name">Получено оплат</td>
                <td>0</td>
                <td>0</td>
                <td>0</td>
                <td>1</td>
              </tr>
            </tbody>
          </table>
        </div>

        <p class="footer-note">
          Подсказка: метрики можно настроить под свои этапы воронки. Значения сохраняются, аналитика строится по выбранному периоду.
        </p>
      </div>
    </section>

    <!-- Экран аналитики -->
    <section class="screen" id="analyticsScreen">
      <div class="dashboard-card">
        <header class="dashboard-header">
          <div>
            <div class="dashboard-title">Аналитика</div>
            <div class="dashboard-subtitle">Сводные данные по дням, неделям и месяцам.</div>
          </div>
          <div class="header-actions">
            <button class="back-btn" id="backToMetrics">К метрикам</button>
            <div class="user-pill" id="userPillAnalytics">Пользователь</div>
          </div>
        </header>

        <div class="period-tabs">
          <button class="period-btn active" data-period="day">День</button>
          <button class="period-btn" data-period="week">Неделя</button>
          <button class="period-btn" data-period="month">Месяц</button>
        </div>

        <div class="analytics-body">
          <div id="analyticsSummary">
            Сегодняшние результаты основаны на текущих значениях метрик.
          </div>

          <div class="analytics-grid" id="analyticsGrid">
            <div class="analytics-card">
              <div class="analytics-value" id="anSets">0</div>
              Количество наборов за период
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="anCalls">0</div>
              Активных звонков за период
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="anMeetPlan">0</div>
              Назначено встреч за период
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="anMeetDone">0</div>
              Проведено встреч за период
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="anKP">0</div>
              Отправлено КП за период
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="anDeals">0</div>
              Получено оплат за период
            </div>
          </div>

          <div class="analytics-section-title">Оценка по 5-балльной шкале (день)</div>
          <div class="analytics-grid score-grid" id="scoreGrid">
            <div class="analytics-card">
              <div class="analytics-value" id="scoreSets">0</div>
              Наборы (1–5)
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="scoreCalls">0</div>
              Активные звонки (1–5)
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="scoreMeetPlan">0</div>
              Назначено встреч (1–5)
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="scoreMeetDone">0</div>
              Проведено встреч (1–5)
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="scoreKP">0</div>
              Отправлено КП (1–5)
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="scoreDeals">0</div>
              Оплаты (1–5)
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-title">График по всем метрикам за период</div>
            <svg id="metricsChart" viewBox="0 0 320 160" preserveAspectRatio="none">
              <line x1="0" y1="140" x2="320" y2="140" stroke="rgba(255,255,255,0.2)" stroke-width="1" />
              <rect id="barSets" class="chart-bar" x="20"  y="140" width="24" height="0" rx="4" />
              <rect id="barCalls" class="chart-bar" x="70"  y="140" width="24" height="0" rx="4" />
              <rect id="barMeetPlan" class="chart-bar" x="120" y="140" width="24" height="0" rx="4" />
              <rect id="barMeetDone" class="chart-bar" x="170" y="140" width="24" height="0" rx="4" />
              <rect id="barKP" class="chart-bar" x="220" y="140" width="24" height="0" rx="4" />
              <rect id="barDeals" class="chart-bar" x="270" y="140" width="24" height="0" rx="4" />
            </svg>
            <div class="chart-legend">
              <span>Наборы</span>
              <span>Активные звонки</span>
              <span>Назначено встреч</span>
              <span>Проведено встреч</span>
              <span>Отправлено КП</span>
              <span>Получено оплат</span>
            </div>
          </div>

          <div class="history-block">
            <div class="history-title">История</div>
            <div class="history-filters">
              <label>С <input type="date" id="historyFrom" /></label>
              <label>По <input type="date" id="historyTo" /></label>
              <button class="history-button" id="historyShow">Показать</button>
            </div>
            <div class="analytics-grid" id="historyGrid">
              <div class="analytics-card">
                <div class="analytics-value" id="hSets">0</div>
                Среднее количество наборов
              </div>
              <div class="analytics-card">
                <div class="analytics-value" id="hCalls">0</div>
                Среднее активных звонков
              </div>
              <div class="analytics-card">
                <div class="analytics-value" id="hMeetPlan">0</div>
                Среднее назначено встреч
              </div>
              <div class="analytics-card">
                <div class="analytics-value" id="hMeetDone">0</div>
                Среднее проведено встреч
              </div>
              <div class="analytics-card">
                <div class="analytics-value" id="hKP">0</div>
                Среднее отправлено КП
              </div>
              <div class="analytics-card">
                <div class="analytics-value" id="hDeals">0</div>
                Среднее оплат
              </div>
            </div>
            <div class="history-note">История хранится локально в браузере и считается по сохранённым измерениям.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const loginButton = document.getElementById('loginButton');
    const loginNameInput = document.getElementById('loginName');
    const loginScreen = document.getElementById('loginScreen');
    const dashboardScreen = document.getElementById('dashboardScreen');
    const analyticsScreen = document.getElementById('analyticsScreen');
    const userPill = document.getElementById('userPill');
    const userPillAnalytics = document.getElementById('userPillAnalytics');
    const analyticsButton = document.getElementById('analyticsButton');
    const backToMetrics = document.getElementById('backToMetrics');

    const metricSets = document.getElementById('metricSets');
    const metricCalls = document.getElementById('metricCalls');
    const metricMeetPlan = document.getElementById('metricMeetPlan');
    const metricMeetDone = document.getElementById('metricMeetDone');
    const metricKP = document.getElementById('metricKP');
    const metricDeals = document.getElementById('metricDeals');

    const metricInputs = document.querySelectorAll('.metric-input');

    const inlineAdvice = document.getElementById('inlineAdvice');
    const inlineAdviceClose = document.getElementById('inlineAdviceClose');
    const inlineAdviceSets = document.getElementById('inlineAdviceSets');
    const inlineAdviceCalls = document.getElementById('inlineAdviceCalls');

    const adviceSound = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_7f6a64e8c1.mp3?filename=notification-113724.mp3');

    const anSets = document.getElementById('anSets');
    const anCalls = document.getElementById('anCalls');
    const anMeetPlan = document.getElementById('anMeetPlan');
    const anMeetDone = document.getElementById('anMeetDone');
    const anKP = document.getElementById('anKP');
    const anDeals = document.getElementById('anDeals');

    const scoreSets = document.getElementById('scoreSets');
    const scoreCalls = document.getElementById('scoreCalls');
    const scoreMeetPlan = document.getElementById('scoreMeetPlan');
    const scoreMeetDone = document.getElementById('scoreMeetDone');
    const scoreKP = document.getElementById('scoreKP');
    const scoreDeals = document.getElementById('scoreDeals');

    const hSets = document.getElementById('hSets');
    const hCalls = document.getElementById('hCalls');
    const hMeetPlan = document.getElementById('hMeetPlan');
    const hMeetDone = document.getElementById('hMeetDone');
    const hKP = document.getElementById('hKP');
    const hDeals = document.getElementById('hDeals');

    const barSets = document.getElementById('barSets');
    const barCalls = document.getElementById('barCalls');
    const barMeetPlan = document.getElementById('barMeetPlan');
    const barMeetDone = document.getElementById('barMeetDone');
    const barKP = document.getElementById('barKP');
    const barDeals = document.getElementById('barDeals');

    const periodButtons = document.querySelectorAll('.period-btn');
    const analyticsSummary = document.getElementById('analyticsSummary');

    const historyFrom = document.getElementById('historyFrom');
    const historyTo = document.getElementById('historyTo');
    const historyShow = document.getElementById('historyShow');

    let currentPeriod = 'day';
    let currentUserName = '';
    const STORAGE_KEY = 'salesMetricsDemo';
    const HISTORY_KEY = 'salesMetricsHistory';
    const API_URL = 'https://script.google.com/macros/s/AKfycbzvT0NJH3um4zrzKTTDBjzLfNCuXRKjC7Wnx68KoDefflX81HuQD4HdxOhwx6Mb8LEm/exec';

    const TARGET_19 = {
      sets: 70,
      calls: 25,
      meetPlan: 2,
      meetDone: 2,
      kp: 2,
      deals: 1
    };

    // Вход
    loginButton.addEventListener('click', () => {
      const name = loginNameInput.value.trim();
      if (!name) {
        loginNameInput.focus();
        return;
      }

      currentUserName = name;
      userPill.textContent = `Здравствуйте, ${name}`;
      userPillAnalytics.textContent = `Здравствуйте, ${name}`;

      loginScreen.classList.remove('active');
      dashboardScreen.classList.add('active');

      updateAdvice();
      updateAnalytics();
    });

    // Переключение экранов
    analyticsButton.addEventListener('click', () => {
      dashboardScreen.classList.remove('active');
      analyticsScreen.classList.add('active');
      updateAnalytics();
    });

    backToMetrics.addEventListener('click', () => {
      analyticsScreen.classList.remove('active');
      dashboardScreen.classList.add('active');
    });

    // Обработчики +/- и ручного ввода
    document.querySelectorAll('.metric-card').forEach(card => {
      const input = card.querySelector('.metric-input');
      const buttons = card.querySelectorAll('.metric-btn');

      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          let value = parseInt(input.value || '0', 10);
          if (btn.dataset.action === 'inc') {
            value += 1;
          } else {
            value = Math.max(0, value - 1);
          }
          input.value = value;
          updateAdvice();
          updateAnalytics();
        });
      });

      input.addEventListener('input', () => {
        let v = parseInt(input.value || '0', 10);
        if (isNaN(v) || v < 0) v = 0;
        input.value = v;
        updateAdvice();
        updateAnalytics();
      });
    });

    // Подсказки по метрикам (встроенный виджет)
    function updateAdvice() {
      const sets = parseInt(metricSets.value || '0', 10);
      const calls = parseInt(metricCalls.value || '0', 10);

      const setsMsg =
        sets <= 20 ? 'Ты вообще работать собираешься' :
        sets <= 40 ? 'Ну неплохо, черт' :
        sets <= 60 ? 'А ты че-то можешь' :
        sets <= 80 ? 'Молодец, парашник' :
                     'Отберите у него телефон';

      const callsMsg =
        calls <= 5  ? 'Ты зачем в офис приехал?' :
        calls <= 10 ? 'Ты там точно работаешь?' :
        calls <= 15 ? 'Неплохо, парашник' :
        calls <= 20 ? 'Давай, поднажми' :
        calls <= 25 ? 'Молодец' :
                      'Остановись, ты не в колл-центре';

      inlineAdviceSets.textContent = setsMsg;
      inlineAdviceCalls.textContent = callsMsg;
      inlineAdvice.style.display = 'block';
      adviceSound.play().catch(() => {});
    }

    inlineAdviceClose.addEventListener('click', () => {
      inlineAdvice.style.display = 'none';
    });

    // Калькуляция оценки 1–5
    function calcScore(value, target) {
      if (!target || target <= 0) return 1;
      const ratio = value / target;
      if (ratio <= 0.2) return 1;
      if (ratio <= 0.4) return 2;
      if (ratio <= 0.6) return 3;
      if (ratio <= 0.8) return 4;
      return 5;
    }

    function updateScoresDay(sets, calls, meetPlan, meetDone, kp, deals) {
      scoreSets.textContent = calcScore(sets, TARGET_19.sets);
      scoreCalls.textContent = calcScore(calls, TARGET_19.calls);
      scoreMeetPlan.textContent = calcScore(meetPlan, TARGET_19.meetPlan);
      scoreMeetDone.textContent = calcScore(meetDone, TARGET_19.meetDone);
      scoreKP.textContent = calcScore(kp, TARGET_19.kp);
      scoreDeals.textContent = calcScore(deals, TARGET_19.deals);
    }

    // Аналитика
    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        periodButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        currentPeriod = btn.dataset.period;

        if (currentPeriod === 'day') {
          analyticsSummary.textContent = 'Сегодняшние результаты основаны на текущих значениях метрик.';
        } else if (currentPeriod === 'week') {
          analyticsSummary.textContent = 'Неделя: текущие метрики умножены примерно на 5 рабочих дней.';
        } else {
          analyticsSummary.textContent = 'Месяц: текущие метрики умножены примерно на 20 рабочих дней.';
        }

        updateAnalytics();
      });
    });

    async function autoSaveToSheet() {
      if (!currentUserName) return;
      const sets = parseInt(metricSets.value || '0', 10);
      const calls = parseInt(metricCalls.value || '0', 10);
      const meetPlan = parseInt(metricMeetPlan.value || '0', 10);
      const meetDone = parseInt(metricMeetDone.value || '0', 10);
      const kp = parseInt(metricKP.value || '0', 10);
      const deals = parseInt(metricDeals.value || '0', 10);

      const payload = { user: currentUserName, sets, calls, meetPlan, meetDone, kp, deals };

      try {
        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (e) {
        console.error('Ошибка Google API', e);
      }
    }

    function saveHistorySnapshot() {
      if (!currentUserName) return;
      const sets = parseInt(metricSets.value || '0', 10);
      const calls = parseInt(metricCalls.value || '0', 10);
      const meetPlan = parseInt(metricMeetPlan.value || '0', 10);
      const meetDone = parseInt(metricMeetDone.value || '0', 10);
      const kp = parseInt(metricKP.value || '0', 10);
      const deals = parseInt(metricDeals.value || '0', 10);

      const now = new Date();
      const date = now.toISOString().slice(0, 10);
      const entry = {
        user: currentUserName,
        date,
        timestamp: now.toISOString(),
        metrics: { sets, calls, meetPlan, meetDone, kp, deals }
      };

      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        arr.push(entry);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
      } catch (e) {
        console.error('Не удалось сохранить историю', e);
      }
    }

    function applyHistoryFilter() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) {
          hSets.textContent = 0;
          hCalls.textContent = 0;
          hMeetPlan.textContent = 0;
          hMeetDone.textContent = 0;
          hKP.textContent = 0;
          hDeals.textContent = 0;
          return;
        }
        const arr = JSON.parse(raw).filter(e => e.user === currentUserName);
        if (!arr.length) {
          hSets.textContent = 0;
          hCalls.textContent = 0;
          hMeetPlan.textContent = 0;
          hMeetDone.textContent = 0;
          hKP.textContent = 0;
          hDeals.textContent = 0;
          return;
        }

        const from = historyFrom.value || '0000-01-01';
        const to = historyTo.value || '9999-12-31';

        const filtered = arr.filter(e => e.date >= from && e.date <= to);
        if (!filtered.length) {
          hSets.textContent = 0;
          hCalls.textContent = 0;
          hMeetPlan.textContent = 0;
          hMeetDone.textContent = 0;
          hKP.textContent = 0;
          hDeals.textContent = 0;
          return;
        }

        let sSets = 0, sCalls = 0, sMeetPlan = 0, sMeetDone = 0, sKP = 0, sDeals = 0;
        filtered.forEach(e => {
          sSets += e.metrics.sets || 0;
          sCalls += e.metrics.calls || 0;
          sMeetPlan += e.metrics.meetPlan || 0;
          sMeetDone += e.metrics.meetDone || 0;
          sKP += e.metrics.kp || 0;
          sDeals += e.metrics.deals || 0;
        });
        const n = filtered.length || 1;
        hSets.textContent = Math.round(sSets / n);
        hCalls.textContent = Math.round(sCalls / n);
        hMeetPlan.textContent = Math.round(sMeetPlan / n);
        hMeetDone.textContent = Math.round(sMeetDone / n);
        hKP.textContent = Math.round(sKP / n);
        hDeals.textContent = Math.round(sDeals / n);
      } catch (e) {
        console.error('Ошибка фильтрации истории', e);
      }
    }

    historyShow.addEventListener('click', applyHistoryFilter);

    function updateAnalytics() {
      const sets = parseInt(metricSets.value || '0', 10);
      const calls = parseInt(metricCalls.value || '0', 10);
      const meetPlan = parseInt(metricMeetPlan.value || '0', 10);
      const meetDone = parseInt(metricMeetDone.value || '0', 10);
      const kp = parseInt(metricKP.value || '0', 10);
      const deals = parseInt(metricDeals.value || '0', 10);

      const rawValues = [sets, calls, meetPlan, meetDone, kp, deals];
      const avg = rawValues.reduce((sum, v) => sum + v, 0) / (rawValues.length || 1);
      const avgElement = document.getElementById('metricsAvg');
      if (avgElement && !isNaN(avg)) {
        avgElement.textContent = avg.toFixed(1);
      }

      rawValues.forEach((value, index) => {
        const input = metricInputs[index];
        if (!input) return;
        input.classList.remove('metric-low', 'metric-high');
        if (value < avg) {
          input.classList.add('metric-low');
        } else if (value > avg) {
          input.classList.add('metric-high');
        }
      });

      let multiplier = 1;
      if (currentPeriod === 'week') multiplier = 5;
      else if (currentPeriod === 'month') multiplier = 20;

      const vals = {
        sets: sets * multiplier,
        calls: calls * multiplier,
        meetPlan: meetPlan * multiplier,
        meetDone: meetDone * multiplier,
        kp: kp * multiplier,
        deals: deals * multiplier
      };

      anSets.textContent = vals.sets;
      anCalls.textContent = vals.calls;
      anMeetPlan.textContent = vals.meetPlan;
      anMeetDone.textContent = vals.meetDone;
      anKP.textContent = vals.kp;
      anDeals.textContent = vals.deals;

      updateChart([
        vals.sets,
        vals.calls,
        vals.meetPlan,
        vals.meetDone,
        vals.kp,
        vals.deals
      ]);

      // Оценки по дню всегда отталкиваются от дневных значений
      updateScoresDay(sets, calls, meetPlan, meetDone, kp, deals);

      if (currentUserName) {
        const data = {
          user: currentUserName,
          metrics: { sets, calls, meetPlan, meetDone, kp, deals },
          updatedAt: new Date().toISOString()
        };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
          console.error('Не удалось сохранить данные', e);
        }
      }

      saveHistorySnapshot();
      autoSaveToSheet();
    }

    function updateChart(values) {
      const max = Math.max(...values, 1);
      const chartHeight = 110;
      const baseY = 140;
      const bars = [barSets, barCalls, barMeetPlan, barMeetDone, barKP, barDeals];

      values.forEach((v, i) => {
        const h = (v / max) * chartHeight;
        const y = baseY - h;
        const bar = bars[i];
        bar.setAttribute('height', h);
        bar.setAttribute('y', y);
      });
    }

    function restoreFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.user) {
          loginNameInput.value = data.user;
          currentUserName = data.user;
          userPill.textContent = `Здравствуйте, ${data.user}`;
          userPillAnalytics.textContent = `Здравствуйте, ${data.user}`;

          // сразу показываем дашборд, без повторного логина
          loginScreen.classList.remove('active');
          dashboardScreen.classList.add('active');
        }
        if (data.metrics) {
          metricSets.value = data.metrics.sets ?? 0;
          metricCalls.value = data.metrics.calls ?? 0;
          metricMeetPlan.value = data.metrics.meetPlan ?? 0;
          metricMeetDone.value = data.metrics.meetDone ?? 0;
          metricKP.value = data.metrics.kp ?? 0;
          metricDeals.value = data.metrics.deals ?? 0;
        }
        updateAdvice();
        updateAnalytics();
        applyHistoryFilter();
      } catch (e) {
        console.error('Ошибка восстановления данных', e);
      }
    }

    restoreFromStorage();

    // СНЕГ
    function createSnowflake() {
      const flake = document.createElement('div');
      flake.className = 'snowflake';
      flake.textContent = '❄';
      flake.style.left = Math.random() * 100 + 'vw';
      flake.style.animationDuration = (4 + Math.random() * 6) + 's';
      flake.style.fontSize = (10 + Math.random() * 10) + 'px';
      document.body.appendChild(flake);
      setTimeout(() => flake.remove(), 10000);
    }

    setInterval(createSnowflake, 200);
  </script>
</body>
</html>

