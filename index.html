
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Sales Focus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #53118F, #140022 80%);
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 2rem;
    }
    .header {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }
    .card {
      background: rgba(0, 0, 0, 0.5);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(147, 61, 201, 0.3);
    }
    .buttons {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #933DC9;
      color: white;
    }
    .chart-container {
      margin-top: 2rem;
    }
  </style>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDf49rE9Mr2jQzPzcKhJi5iuUegqjGY8Q",
    authDomain: "sales-focus-tracker.firebaseapp.com",
    projectId: "sales-focus-tracker",
    storageBucket: "sales-focus-tracker.firebasestorage.app",
    messagingSenderId: "585476913483",
    appId: "1:585476913483:web:c6696bd731288a7056d0ce",
    measurementId: "G-VFMHMDJW0R"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window._firebase = { db, doc, setDoc, getDoc, collection, getDocs, query, where };
</script>

</head>
<body>
  <div class="header">
    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="username"></span>!
  </div>

  
<div style="margin-bottom: 1rem;">
  <button onclick="showTab('main')" style="margin-right:10px;">–°–µ–≥–æ–¥–Ω—è</button>
  <button onclick="showTab('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
</div>

<div id="mainTab">
<div class="metrics">
    <div class="card">
      <div>üìû –ó–≤–æ–Ω–∫–∏: <span id="calls">0</span> / <span id="callsGoal">70</span></div>
      <div class="buttons">
        <button onclick="change('calls', 1)">+ –ó–≤–æ–Ω–æ–∫</button>
        <button onclick="change('calls', -1)">‚Äì –ó–≤–æ–Ω–æ–∫</button>
      </div>
    </div>
    <div class="card">
      <div>üì≤ –î–æ–∑–≤–æ–Ω—ã: <span id="reached">0</span> / <span id="reachedGoal">25</span></div>
      <div class="buttons">
        <button onclick="change('reached', 1)">+ –î–æ–∑–≤–æ–Ω</button>
        <button onclick="change('reached', -1)">‚Äì –î–æ–∑–≤–æ–Ω</button>
      </div>
    </div>
    <div class="card">
      <div>ü§ù –í—Å—Ç—Ä–µ—á–∏: <span id="meetings">0</span></div>
      <div class="buttons">
        <button onclick="change('meetings', 1)">+ –í—Å—Ç—Ä–µ—á–∞</button>
        <button onclick="change('meetings', -1)">‚Äì –í—Å—Ç—Ä–µ—á–∞</button>
      </div>
    </div>
    <div class="card">
      <div>üìÖ –ù–∞–∑–Ω–∞—á–µ–Ω–æ: <span id="scheduled">0</span></div>
      <div class="buttons">
        <button onclick="change('scheduled', 1)">+ –ù–∞–∑–Ω–∞—á–µ–Ω–æ</button>
        <button onclick="change('scheduled', -1)">‚Äì –ù–∞–∑–Ω–∞—á–µ–Ω–æ</button>
      </div>
    </div>
  </div>

  
    <div class="card">
      <div>üìù –ù–∞–∑–Ω–∞—á–µ–Ω–æ –ö–ü: <span id="kpset">0</span></div>
      <div class="buttons">
        <button onclick="change('kpset', 1)">+ –ù–∞–∑–Ω–∞—á–µ–Ω–æ</button>
        <button onclick="change('kpset', -1)">‚Äì –ù–∞–∑–Ω–∞—á–µ–Ω–æ</button>
      </div>
    </div>
    <div class="card">
      <div>üì® –ü—Ä–æ–≤–µ–¥–µ–Ω–æ –ö–ü: <span id="kpsent">0</span></div>
      <div class="buttons">
        <button onclick="change('kpsent', 1)">+ –ü—Ä–æ–≤–µ–¥–µ–Ω–æ</button>
        <button onclick="change('kpsent', -1)">‚Äì –ü—Ä–æ–≤–µ–¥–µ–Ω–æ</button>
      </div>
    </div>

  </div><div id="analyticsTab" style="display:none;">
<h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
<div style="margin-bottom:1rem;">
  –ü–µ—Ä–∏–æ–¥:
  <label><input type="radio" name="period" value="day" checked> –î–µ–Ω—å</label>
  <label><input type="radio" name="period" value="week"> –ù–µ–¥–µ–ª—è</label>
  <label><input type="radio" name="period" value="month"> –ú–µ—Å—è—Ü</label>
  <button onclick="loadAnalytics()">–û–±–Ω–æ–≤–∏—Ç—å</button>
</div>
<canvas id="analyticsChart" height="120"></canvas>
<div id="analyticsTable" style="margin-top:1rem;"></div>
<div style="margin-top:1rem;">
  <h3>üìå –û–±—â–∏–π —Å–æ–≤–µ—Ç:</h3>
  <p id="adviceGeneral">‚Äî</p>
  <h3>üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:</h3>
  <p id="advicePractical">‚Äî</p>
</div>
</div>
<div class="chart-container">
    <canvas id="activityChart"></canvas>
  </div>

  <script>
    const user = localStorage.getItem("userName");
    if (!user) window.location.href = "login.html";
    document.getElementById("username").textContent = user;

    let data = {
      kpset: 0,
      kpsent: 0,
      calls: 0,
      reached: 0,
      meetings: 0,
      scheduled: 0,
      callsGoal: 70,
      reachedGoal: 25
    };

    const ctx = document.getElementById("activityChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ["–ó–≤–æ–Ω–∫–∏", "–î–æ–∑–≤–æ–Ω—ã", "–í—Å—Ç—Ä–µ—á–∏", "–ù–∞–∑–Ω–∞—á–µ–Ω–æ", "–ö–ü –ù–∞–∑–Ω–∞—á–µ–Ω–æ", "–ö–ü –ü—Ä–æ–≤–µ–¥–µ–Ω–æ"],
        datasets: [{
          label: '–¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è',
          data: [0, 0, 0, 0, 0, 0],
          backgroundColor: '#933DC9'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: '–¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'
          }
        }
      }
    });

    function change(metric, delta) {
      if (!(metric in data)) return;
      data[metric] = Math.max(0, data[metric] + delta);
      adjustGoals();
      update();
    }

    function adjustGoals() {
      if (data.meetings >= 3) {
        data.callsGoal = 30;
        data.reachedGoal = 10;
      } else if (data.meetings == 2) {
        data.callsGoal = 50;
        data.reachedGoal = 15;
      } else if (data.meetings == 1) {
        data.callsGoal = 60;
        data.reachedGoal = 20;
      } else {
        data.callsGoal = 70;
        data.reachedGoal = 25;
      }
    }

    function update() {
      document.getElementById('kpset').textContent = data.kpset;
      document.getElementById('kpsent').textContent = data.kpsent;
      document.getElementById("calls").textContent = data.calls;
      document.getElementById("reached").textContent = data.reached;
      document.getElementById("meetings").textContent = data.meetings;
      document.getElementById("scheduled").textContent = data.scheduled;
      document.getElementById("callsGoal").textContent = data.callsGoal;
      document.getElementById("reachedGoal").textContent = data.reachedGoal;

      chart.data.datasets[0].data = [
        data.calls, data.reached, data.meetings, data.scheduled, data.kpset, data.kpsent
      ];
      chart.update();
    }

    update();
  </script>

<script>
function showTab(tab) {
  document.getElementById('mainTab').style.display = tab === 'main' ? 'block' : 'none';
  document.getElementById('analyticsTab').style.display = tab === 'analytics' ? 'block' : 'none';
}
</script>


<script type="module">
import { formatISO, subDays } from "https://cdn.skypack.dev/date-fns";

const db = window._firebase.db;
const { collection, query, where, getDocs } = window._firebase;

async function loadAnalytics() {
  const user = localStorage.getItem("userName");
  const period = document.querySelector('input[name="period"]:checked').value;

  const today = new Date();
  let start = new Date();
  if (period === "week") start = subDays(today, 6);
  if (period === "month") start = subDays(today, 29);
  const startStr = formatISO(start, { representation: 'date' });
  const endStr = formatISO(today, { representation: 'date' });

  const q = query(
    collection(db, "users", user, "history"),
    where("date", ">=", startStr),
    where("date", "<=", endStr)
  );
  const snapshot = await getDocs(q);
  const rows = [], labels = [], calls = [], reached = [], meetings = [];

  snapshot.forEach(doc => {
    const d = doc.data();
    labels.push(doc.id);
    calls.push(d.calls || 0);
    reached.push(d.reached || 0);
    meetings.push(d.meetings || 0);
    rows.push(`<tr><td>${doc.id}</td><td>${d.calls}</td><td>${d.reached}</td><td>${d.meetings}</td></tr>`);
  });

  document.getElementById("analyticsTable").innerHTML =
    "<table border='1' cellpadding='6'><tr><th>–î–∞—Ç–∞</th><th>–ó–≤–æ–Ω–∫–∏</th><th>–î–æ–∑–≤–æ–Ω—ã</th><th>–í—Å—Ç—Ä–µ—á–∏</th></tr>" +
    rows.join("") + "</table>";

  const ctx = document.getElementById("analyticsChart").getContext("2d");
  new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "–ó–≤–æ–Ω–∫–∏", data: calls, borderColor: "#933DC9", tension: 0.3 },
        { label: "–î–æ–∑–≤–æ–Ω—ã", data: reached, borderColor: "#5AC8FA", tension: 0.3 },
        { label: "–í—Å—Ç—Ä–µ—á–∏", data: meetings, borderColor: "#4CD964", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "–î–∏–Ω–∞–º–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏" }
      }
    }
  });

  const avgCalls = calls.reduce((a,b)=>a+b,0)/calls.length || 0;
  const avgReached = reached.reduce((a,b)=>a+b,0)/reached.length || 0;
  const conversion = avgReached / avgCalls;
  document.getElementById("adviceGeneral").textContent =
    conversion < 0.3
      ? "–ö–æ–Ω–≤–µ—Ä—Å–∏—è –¥–æ–∑–≤–æ–Ω–æ–≤ –Ω–∏–∂–µ –Ω–æ—Ä–º—ã ‚Äî –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏ –ø–æ–¥—Ö–æ–¥ –∫ —Å–∫—Ä–∏–ø—Ç–∞–º."
      : "–ö–æ–Ω–≤–µ—Ä—Å–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.";

  const minIdx = reached.indexOf(Math.min(...reached));
  document.getElementById("advicePractical").textContent =
    `–í –¥–µ–Ω—å ${labels[minIdx]} –±—ã–ª–æ –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –¥–æ–∑–≤–æ–Ω–æ–≤ ‚Äî —É—Å–∏–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ –∑–≤–æ–Ω–∫–∞—Ö –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏.`;
}

window.loadAnalytics = loadAnalytics;
</script>

</body>
</html>
